var W=Object.defineProperty;var q=(a,e,t)=>e in a?W(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var f=(a,e,t)=>(q(a,typeof e!="symbol"?e+"":e,t),t),H=(a,e,t)=>{if(!e.has(a))throw TypeError("Cannot "+t)};var d=(a,e,t)=>(H(a,e,"read from private field"),t?t.call(a):e.get(a)),B=(a,e,t)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,t)};(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const S=new WeakMap,O=(a,e)=>{var r,s;if(S.has(a)||S.set(a,new WeakSet),((r=S.get(a))==null?void 0:r.has(e))==!0)return!0;const t=e.prototype;let n=a.prototype,i=100;do{if(n===t)return(s=S.get(a))==null||s.add(e),!0;n=Object.getPrototypeOf(n)}while(n&&i--);return!1},M=(a,e,t,n,i,r)=>{if(typeof i!=typeof n){r.push(`invalid value type. json:${i}[${typeof i}], type:[${typeof n}]`);return}if(e&&!e(i)){r.push(`validation error. json:${i}`);return}return a?a(i):i},A=(a,e,t,n,i)=>{let r=t.factory,s;if(O(r,g)){if(g.subTypes(r,u=>(s=p.parse(u,n),!s)),s)return s;i.push(`no matched union. json:${n}`);return}else if(O(r,p))s=p.parse(t.factory,n,u=>i.push(...u));else if(s=new t.factory,a)s=a(s);else if(s.fromJSON)s.fromJSON(n);else{const u=Object.keys(n);for(let c=0,o=u.length;c<o;c++){const h=u[c];s[h]=n[h]}}if(e&&!e(n)){i.push(`validation error. json:${n}`);return}return s},b=class{constructor(e,t){f(this,"fromJSON");f(this,"name");this.name=e,this.fromJSON=t}};let y=b;f(y,"value",new b("value",(e,t,n,i,r,s)=>{const u=M(e,t,n,n.instance,r,s);if(s.length){s.push(`${s.pop()}, key:${i}`);return}return u})),f(y,"object",new b("object",(e,t,n,i,r,s)=>{const u=A(e,t,n,r,s);if(s.length){s.push(`${s.pop()}, key:${i}`);return}return u})),f(y,"valueArray",new b("valueArray",(e,t,n,i,r,s)=>{if(!(r instanceof Array)){s.push(`invalid array. json: ${r}`);return}n.instance===void 0&&(n.instance=n.factory());const u=[];for(let c=0,o=r.length;c<o;c++)if(u.push(M(e,t,n,n.instance,r[c],s)),s.length){s.push(`invalid array item type. item: ${r[c]}, index:${c}, error:${s.pop()}, key:${i}`);return}return u})),f(y,"objectArray",new b("objectArray",(e,t,n,i,r,s)=>{if(!(r instanceof Array)){s.push(`invalid array. json: ${r}`);return}const u=[];for(let c=0,o=r.length;c<o;c++)if(u.push(A(e,t,n,r[c],s)),s.length){s.push(`invalid array item type. item: ${r[c]}, index:${c}, error:${s.pop()}, key:${i}`);return}return u})),f(y,"valueMap",new b("valueMap",(e,t,n,i,r,s)=>{if(!r||typeof r!="object"){s.push(`invalid object. json: ${r}`);return}const u=Object.keys(r),c={};n.instance===void 0&&(n.instance=n.factory());for(let o=0,h=u.length;o<h;o++){const l=u[o];if(c[l]=M(e,t,n,n.instance,r[l],s),s.length){s.push(`invalid object item type. item: ${r[l]}, objectkey:${l}, error:${s.pop()}, key:${l}`);return}}return c})),f(y,"objectMap",new b("objectMap",(e,t,n,i,r,s)=>{if(!r||typeof r!="object"){s.push(`invalid object. json: ${r}`);return}const u=Object.keys(r),c={};for(let o=0,h=u.length;o<h;o++){const l=u[o];if(c[l]=A(e,t,n,r[l],s),s.length){s.push(`invalid object item type. item: ${r[l]}, objectkey:${l}, error:${s.pop()}, key:${l}`);return}}return c}));const J=new WeakMap;var m;const E=class{constructor(){B(this,m,[])}static parse(e,t,n,i){if(typeof t=="string"&&(t=JSON.parse(t)),!i&&O(e,g)){let o=[],h;return g.subTypes(e,l=>(o.push(l.name),h=E.parse(l,t,void 0,!0),!h)),h||(n&&n([`no matched union. union:${e.name}, subType:${o.join(",")}`]),null)}const r=new e,[s,u]=r.fields,c=[];for(let o=0,h=s.length;o<h;o++){const l=s[o];if(typeof l=="symbol")continue;const v=t[l],{validator:k,optional:T,fromJSON:U,__meta__:w}=u[l];if(v===void 0){if(T)continue;c.push(`no key. key:${String(l)}`);break}if(!w){c.push(`no meta data. key: ${String(l)}`);break}const I=w.type.fromJSON(U,k,w,l,v,c);if(I===void 0)break;r[l]=I}return c.length?(n&&n(c),null):r}get fields(){if(!J.has(this.constructor)){const e=Reflect.ownKeys(this);J.set(this.constructor,[e,e.reduce((t,n,i)=>(t[n]=d(this,m)[i],t),{})])}return J.get(this.constructor)}toJSON(){const[e,t]=this.fields;return e.reduce((n,i)=>{var s,u;const r=this[i];return n[i]=((u=(s=t[i]).toJSON)==null?void 0:u.call(s,r))??r,n},{})}value(e,t={}){const n=e();if(typeof n=="object")throw`${n} is no value`;return t.__meta__={type:y.value,factory:e,instance:n},d(this,m).push(t),n}object(e,t={}){return t.__meta__={type:y.object,factory:e},d(this,m).push(t),{}}valueArray(e,t={}){return t.__meta__={type:y.valueArray,factory:e},d(this,m).push(t),[]}objectArray(e,t={}){return t.__meta__={type:y.objectArray,factory:e},d(this,m).push(t),{}}valueMap(e,t={}){return t.__meta__={type:y.valueMap,factory:e},d(this,m).push(t),{}}objectMap(e,t={}){return t.__meta__={type:y.objectMap,factory:e},d(this,m).push(t),{}}get STRING(){return this.value(String)}string(e){return this.value(String,e)}get BOOL(){return this.value(Boolean)}bool(e){return this.value(Boolean,e)}get NUMBER(){return this.value(Number)}number(e){return this.value(Number,e)}};let p=E;m=new WeakMap;class g extends p{static subTypes(e,t){const n=Object.values(e);for(let i=0,r=n.length;i<r;i++){const s=n[i];if(s&&typeof s=="function"&&O(s,e)&&!t(s))break}}}let K="";const G=' <span class="ok">ok</span>',P=' <span class="fail">fail</span>';function L(a,e){const t={html:""},n=p.parse(a,e,r=>t.html+=r);let i=n?j(n,e,t,0):!1;K+=`<h2>${a.name} - ${i?G:P}</h2>`+t.html}function j(a,e,t,n){const[,i]=a.fields;let r=!0,s="";return Reflect.ownKeys(a).forEach(u=>{const c=a[u],o=e[u],h=i[u].__meta__.type,l={html:""};let v=!1,k=c instanceof p;k?j(c,o,l,n+1)&&(v=!0):(R(c,o,l,n+1)&&(v=!0),s+=""),v||(r=!1),s+=`<div class="key">${v?G:P} ${String(u)} : ${h.name}</div>        
            ${k?"":`<div>origin ${JSON.stringify(c)}</div>`} 
            ${k?"":`<div>json ${JSON.stringify(o)}</div>`} 
            <div>${l.html}</div>`}),t.html+=`<section style="margin-left:${n*20}px">
<pre>origin[${a.constructor.name}]: ${JSON.stringify(a)}</pre>
<pre>json: ${JSON.stringify(e)}</pre>${s}
</section>`,r}function R(a,e,t,n){return a&&typeof a=="object"?a instanceof Array?a.every((i,r)=>R(i,e[r],t,n)):a instanceof p?j(a,e,t,n+1):Reflect.ownKeys(a).every(i=>R(a[i],e[i],t,n)):a===e}function V(){document.querySelector("#root").innerHTML=K}class N extends p{constructor(){super(...arguments);f(this,"name",this.value(String));f(this,"num",this.value(Number));f(this,"nick",this.STRING)}}class z extends N{constructor(){super(...arguments);f(this,"list",this.valueArray(String));f(this,"map",this.valueMap(Number))}}class D extends N{constructor(){super(...arguments);f(this,"entity",this.object(N))}}L(N,{nick:"nick",name:"hika",num:122343});L(z,{nick:"nick",name:"hika",num:122343,list:["a","b"],map:{a:34,b:5}});L(D,{nick:"nick",name:"hika",num:122343,list:["a","b"],entity:{nick:"entity nick",name:"entity hika",num:55555}});V();const _=class extends g{};let $=_;f($,"A",class extends _{constructor(){super(...arguments);f(this,"astr",this.STRING);f(this,"anum",this.NUMBER)}}),f($,"B",class extends _{constructor(){super(...arguments);f(this,"bstr",this.STRING);f(this,"bnum",this.NUMBER)}});console.log("---------------------");const x=p.parse($,{bstr:"bbb",bnum:1111});console.log(x,x instanceof $.B,JSON.stringify(x));
