(function(h,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(h=typeof globalThis<"u"?globalThis:h||self,p(h.entity={}))})(this,function(h){"use strict";const p=new WeakMap,d=(y,e)=>{if(p.has(y)||p.set(y,new WeakSet),p.get(y)?.has(e)==!0)return!0;const i=e.prototype;let t=y.prototype,u=100;do{if(t===i)return p.get(y)?.add(e),!0;t=Object.getPrototypeOf(t)}while(t&&u--);return!1},$=(y,e,i,t,u,r)=>{if(typeof u!=typeof t){r.push(`invalid value type. json:${u}[${typeof u}], type:[${typeof t}]`);return}if(e&&!e(u)){r.push(`validation error. json:${u}`);return}return y?y(u):u},k=(y,e,i,t,u)=>{let r=i.factory,n;if(d(r,v)){if(v.subTypes(r,a=>(n=b.parse(a,t),!n)),n)return n;u.push(`no matched union. json:${t}`);return}else if(d(r,b))n=b.parse(i.factory,t,a=>u.push(...a));else if(n=new i.factory,y)n=y(n);else if(n.fromJSON)n.fromJSON(t);else{const a=Object.keys(t);for(let s=0,l=a.length;s<l;s++){const f=a[s];n[f]=t[f]}}if(e&&!e(t)){u.push(`validation error. json:${t}`);return}return n};class o{static value=new o("value",(e,i,t,u,r,n)=>{const a=$(e,i,t,t.instance,r,n);if(n.length){n.push(`${n.pop()}, key:${u}`);return}return a});static object=new o("object",(e,i,t,u,r,n)=>{const a=k(e,i,t,r,n);if(n.length){n.push(`${n.pop()}, key:${u}`);return}return a});static valueArray=new o("valueArray",(e,i,t,u,r,n)=>{if(!(r instanceof Array)){n.push(`invalid array. json: ${r}`);return}t.instance===void 0&&(t.instance=t.factory());const a=[];for(let s=0,l=r.length;s<l;s++)if(a.push($(e,i,t,t.instance,r[s],n)),n.length){n.push(`invalid array item type. item: ${r[s]}, index:${s}, error:${n.pop()}, key:${u}`);return}return a});static objectArray=new o("objectArray",(e,i,t,u,r,n)=>{if(!(r instanceof Array)){n.push(`invalid array. json: ${r}`);return}const a=[];for(let s=0,l=r.length;s<l;s++)if(a.push(k(e,i,t,r[s],n)),n.length){n.push(`invalid array item type. item: ${r[s]}, index:${s}, error:${n.pop()}, key:${u}`);return}return a});static valueMap=new o("valueMap",(e,i,t,u,r,n)=>{if(!r||typeof r!="object"){n.push(`invalid object. json: ${r}`);return}const a=Object.keys(r),s={};t.instance===void 0&&(t.instance=t.factory());for(let l=0,f=a.length;l<f;l++){const c=a[l];if(s[c]=$(e,i,t,t.instance,r[c],n),n.length){n.push(`invalid object item type. item: ${r[c]}, objectkey:${c}, error:${n.pop()}, key:${c}`);return}}return s});static objectMap=new o("objectMap",(e,i,t,u,r,n)=>{if(!r||typeof r!="object"){n.push(`invalid object. json: ${r}`);return}const a=Object.keys(r),s={};for(let l=0,f=a.length;l<f;l++){const c=a[l];if(s[c]=k(e,i,t,r[c],n),n.length){n.push(`invalid object item type. item: ${r[c]}, objectkey:${c}, error:${n.pop()}, key:${c}`);return}}return s});fromJSON;name;constructor(e,i){this.name=e,this.fromJSON=i}}const g=new WeakMap;class b{static parse(e,i,t,u){if(typeof i=="string"&&(i=JSON.parse(i)),!u&&d(e,v)){let l=[],f;return v.subTypes(e,c=>(l.push(c.name),f=b.parse(c,i,void 0,!0),!f)),f||(t&&t([`no matched union. union:${e.name}, subType:${l.join(",")}`]),null)}const r=new e,[n,a]=r.fields,s=[];for(let l=0,f=n.length;l<f;l++){const c=n[l];if(typeof c=="symbol")continue;const _=i[c],{validator:S,optional:w,fromJSON:N,__meta__:m}=a[c];if(_===void 0){if(w)continue;s.push(`no key. key:${String(c)}`);break}if(!m){s.push(`no meta data. key: ${String(c)}`);break}const O=m.type.fromJSON(N,S,m,c,_,s);if(O===void 0)break;r[c]=O}return s.length?(t&&t(s),null):r}#e=[];get fields(){if(!g.has(this.constructor)){const e=Reflect.ownKeys(this);g.set(this.constructor,[e,e.reduce((i,t,u)=>(i[t]=this.#e[u],i),{})])}return g.get(this.constructor)}toJSON(){const[e,i]=this.fields;return e.reduce((t,u)=>{const r=this[u];return t[u]=i[u].toJSON?.(r)??r,t},{})}value(e,i={}){const t=e();if(typeof t=="object")throw`${t} is no value`;return i.__meta__={type:o.value,factory:e,instance:t},this.#e.push(i),t}object(e,i={}){return i.__meta__={type:o.object,factory:e},this.#e.push(i),{}}valueArray(e,i={}){return i.__meta__={type:o.valueArray,factory:e},this.#e.push(i),[]}objectArray(e,i={}){return i.__meta__={type:o.objectArray,factory:e},this.#e.push(i),{}}valueMap(e,i={}){return i.__meta__={type:o.valueMap,factory:e},this.#e.push(i),{}}objectMap(e,i={}){return i.__meta__={type:o.objectMap,factory:e},this.#e.push(i),{}}get STRING(){return this.value(String)}string(e){return this.value(String,e)}get BOOL(){return this.value(Boolean)}bool(e){return this.value(Boolean,e)}get NUMBER(){return this.value(Number)}number(e){return this.value(Number,e)}}class v extends b{static subTypes(e,i){const t=Object.values(e);for(let u=0,r=t.length;u<r;u++){const n=t[u];if(n&&typeof n=="function"&&d(n,e)&&!i(n))break}}}h.Entity=b,h.FieldType=o,h.Union=v,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
