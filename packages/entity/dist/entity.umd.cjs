(function(h,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(h=typeof globalThis<"u"?globalThis:h||self,p(h.entity={}))})(this,function(h){"use strict";const p=new WeakMap,$=(y,t)=>{if(p.has(y)||p.set(y,new WeakSet),p.get(y)?.has(t)==!0)return!0;const n=t.prototype;let e=y.prototype,u=100;do{if(e===n)return p.get(y)?.add(t),!0;e=Object.getPrototypeOf(e)}while(e&&u--);return!1},k=(y,t,n,e,u)=>{if(typeof e!=typeof n){u.push(`invalid value type. json:${e}[${typeof e}], type:[${typeof n}]`);return}if(t&&!t(e)){u.push(`validation error. json:${e}`);return}return y?y(e):e},g=(y,t,n,e,u)=>{if(t&&!t(e)){u.push(`validation error. json:${e}`);return}let i;if(y)i=y(e);else{let r=n.factory;if($(r,d)){if(d.subTypes(r,a=>(i=v.parse(a,e),!i)),i)return i;u.push(`no matched union. json:${e}`);return}else if($(r,v))i=v.parse(r,e,a=>u.push(...a));else if(i=new r,i.fromJSON)i.fromJSON(e);else{const a=Object.keys(e);for(let s=0,l=a.length;s<l;s++){const o=a[s];i[o]=e[o]}}}return i};class f{static value=new f("value",(t,n,e,u,i,r)=>{const a=k(t,n,e.instance,i,r);if(r.length){r.push(`${r.pop()}, key:${u}`);return}return a});static object=new f("object",(t,n,e,u,i,r)=>{const a=g(t,n,e,i,r);if(r.length){r.push(`${r.pop()}, key:${u}`);return}return a});static valueArray=new f("valueArray",(t,n,e,u,i,r)=>{if(!(i instanceof Array)){r.push(`invalid array. json: ${i}`);return}e.instance===void 0&&(e.instance=e.factory());const a=[];for(let s=0,l=i.length;s<l;s++){const o=k(t,n,e.instance,i[s],r);if(r.length){r.push(`invalid array item type. item: ${i[s]}, index:${s}, error:${r.pop()}, key:${u}`);return}a.push(o)}return a});static objectArray=new f("objectArray",(t,n,e,u,i,r)=>{if(!(i instanceof Array)){r.push(`invalid array. json: ${i}`);return}const a=[];for(let s=0,l=i.length;s<l;s++){const o=g(t,n,e,i[s],r);if(r.length){r.push(`invalid array item type. item: ${i[s]}, index:${s}, error:${r.pop()}, key:${u}`);return}a.push(o)}return a});static valueMap=new f("valueMap",(t,n,e,u,i,r)=>{if(!i||typeof i!="object"){r.push(`invalid object. json: ${i}`);return}const a=Object.keys(i),s={};e.instance===void 0&&(e.instance=e.factory());for(let l=0,o=a.length;l<o;l++){const c=a[l],b=k(t,n,e.instance,i[c],r);if(r.length){r.push(`invalid object item type. item: ${i[c]}, objectkey:${c}, error:${r.pop()}, key:${c}`);return}s[c]=b}return s});static objectMap=new f("objectMap",(t,n,e,u,i,r)=>{if(!i||typeof i!="object"){r.push(`invalid object. json: ${i}`);return}const a=Object.keys(i),s={};for(let l=0,o=a.length;l<o;l++){const c=a[l],b=g(t,n,e,i[c],r);if(r.length){r.push(`invalid object item type. item: ${i[c]}, objectkey:${c}, error:${r.pop()}, key:${c}`);return}s[c]=b}return s});fromJSON;name;constructor(t,n){this.name=t,this.fromJSON=n}}const m=new WeakMap;class v{static parse(t,n,e,u){if(typeof n=="string"&&(n=JSON.parse(n)),!u&&$(t,d)){let l=[],o;return d.subTypes(t,c=>(l.push(c.name),o=v.parse(c,n,void 0,!0),!o)),o||(e&&e([`no matched union. union:${t.name}, subType:${l.join(",")}`]),null)}const i=new t,[r,a]=i.fields,s=[];for(let l=0,o=r.length;l<o;l++){const c=r[l];if(typeof c=="symbol")continue;const b=n[c],{validator:S,optional:w,fromJSON:N,__meta__:_}=a[c];if(b===void 0){if(w)continue;s.push(`no key. key:${String(c)}`);break}if(!_){s.push(`no meta data. key: ${String(c)}`);break}const O=_.type.fromJSON(N,S,_,c,b,s);if(O===void 0)break;i[c]=O}return s.length?(e&&e(s),null):i}#e=[];get fields(){if(!m.has(this.constructor)){const t=Object.getOwnPropertyNames(this);m.set(this.constructor,[t,t.reduce((n,e,u)=>(n[e]=this.#e[u],n),{})])}return m.get(this.constructor)}toJSON(){const[t,n]=this.fields;return t.reduce((e,u)=>{const i=this[u];return e[u]=n[u].toJSON?.(i)??i,e},{})}value(t,n={}){const e=t();if(typeof e=="object")throw`${e} is no value`;return n.__meta__={type:f.value,factory:t,instance:e},this.#e.push(n),e}object(t,n={}){return n.__meta__={type:f.object,factory:t},this.#e.push(n),{}}valueArray(t,n={}){return n.__meta__={type:f.valueArray,factory:t},this.#e.push(n),[]}objectArray(t,n={}){return n.__meta__={type:f.objectArray,factory:t},this.#e.push(n),{}}valueMap(t,n={}){return n.__meta__={type:f.valueMap,factory:t},this.#e.push(n),{}}objectMap(t,n={}){return n.__meta__={type:f.objectMap,factory:t},this.#e.push(n),{}}get STRING(){return this.value(String)}string(t){return this.value(String,t)}get BOOL(){return this.value(Boolean)}bool(t){return this.value(Boolean,t)}get NUMBER(){return this.value(Number)}number(t){return this.value(Number,t)}}class d extends v{static subTypes(t,n){const e=Object.values(t);for(let u=0,i=e.length;u<i;u++){const r=e[u];if(r&&typeof r=="function"&&$(r,t)&&!n(r))break}}}h.Entity=v,h.FieldType=f,h.Union=d,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
